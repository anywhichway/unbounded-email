<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<title>Spaces</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="../index.css">
<link rel="stylesheet" href="./index.css">
<link rel="stylesheet" href="main-styles.css">
<link id="active-theme-stylesheet" rel="stylesheet" href="themes/light.css">
<script src="../../assets/js/lightview.js"></script>
<script>
    const lightview = Lightview("browser");
    const {render, state, navigate} = lightview;
</script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<script src="index.js"></script>
<script src="../folder-item.js"></script>
<script type="module" id="init">
    const {user, ui} = await lightview.import("./", { publish: true, subscribe: true });

    const getAccountIconClass = (accountEmail) => {
        const account = user.accounts[accountEmail];
        const accountType = account?.type;
        return ui.accountIcons?.[accountType] || ui.accountIcons?.default || 'fas fa-envelope';
    };

    // Get user accounts from user structure
    const userAccounts = user.accounts || {};
    
    // Mapping from folder names to section IDs
    const folderToSection = {
        "Chat": "chatSection",
        "Video Chat": "videoChatSection",
        "Audio Chat": "audioChatSection",
        "Screen Share": "screenShareSection",
        "Whiteboard": "whiteboardSection",
        "Kanban": "kanbanSection",
        "Documents": "documentsSection",
        "Settings": "settingsSection"
    };

    const showChatSection = () => {
        const contentSections = document.querySelectorAll('.content-section');
        contentSections.forEach(section => section.classList.add('hidden'));
        const chatSection = document.getElementById('chatSection');
        if (chatSection) {
            chatSection.classList.remove('hidden');
        }
    };

    const appState = state({
        user: user,
        currentAccount: null,
        currentFolder: null,
        selectedFolderId: 'folder-Spaces',
        
        // NEW: Central state for the active workspace
        workspace: null, // Initially null, populated on join

        getAccountIconClass,
        getCount: ({ folder, accountEmail, tagName, state }) => 0, // For now, no counts
        async selectFolder(folderType, value) {
            // const spaces = JSON.parse(localStorage.getItem('spacesList') || '{}');
            if (folderType === 'account') {
                const roomName = value; // value is the account email
                
                this.workspace = {
                    roomId: roomName,
                    nickname: localStorage.getItem('viewPartyNickname') || roomName,
                    isHost: true,
                    status: 'disconnected',
                    peers: {},
                    chatHistory: [],
                    channels: [],
                    currentActiveChannelId: null,
                    kanbanData: { columns: [] },
                    whiteboardHistory: [],
                    documents: {},
                };

                // Call the setup function. It's async.
                await window.joinRoomAndSetup(this);
                
                if (this.workspace && this.workspace.status === 'connected') {
                    console.log(`Joined personal space '${roomName}' and assumed host role.`);
                    showChatSection();
                    this.selectedFolderId = 'folder-Chat';
                }

            } else if (folderType === 'folder') {
                this.currentFolder = value;
                this.currentAccount = null;
                this.selectedFolderId = `folder-${value}`;
                // Special handling for Export Workspace
                if (value === "Export Workspace") {
                    window.onClickExportWorkspace();
                    return;
                }
                // Special handling for Create Space
                if (value === "Create Space") {
                    document.getElementById('inRoomInterface').classList.add('hidden');
                    document.getElementById('setupSection').classList.remove('hidden');
                    document.getElementById('createWorkspaceFields').classList.remove('hidden');
                    document.getElementById('joinWorkspaceFields').classList.add('hidden');
                }
                // Special handling for Join Space
                if (value === "Join Space") {
                    document.getElementById('inRoomInterface').classList.add('hidden');
                    document.getElementById('setupSection').classList.remove('hidden');
                    document.getElementById('joinWorkspaceFields').classList.remove('hidden');
                    document.getElementById('createWorkspaceFields').classList.add('hidden');
                }
                // If it's an existing space
                // if (spaces[value]) {
                //     this.workspace = {
                //         roomId: value,
                //         nickname: localStorage.getItem('viewPartyNickname') || '',
                //         isHost: false, // Assuming joining a saved space means you are not the host initially
                //         status: 'disconnected',
                //         peers: {},
                //         // ... other fields will be loaded from localStorage in joinRoomAndSetup
                //     };
                //     await window.joinRoomAndSetup(this);
                // }
                // If it's a tab folder, switch to that section
                const sectionId = folderToSection[value];
                if (sectionId) {
                    const targetSectionElement = document.getElementById(sectionId);
                    if (targetSectionElement) {
                        const contentSections = document.querySelectorAll('.content-section');
                        contentSections.forEach(section => section.classList.add('hidden'));
                        targetSectionElement.classList.remove('hidden');
                        
                        // Also update sidebar button active state
                        const sidebarButtons = document.querySelectorAll('.sidebar-button');
                        sidebarButtons.forEach(btn => {
                            if (btn.getAttribute('data-section') === sectionId) {
                                btn.classList.add('active');
                            } else {
                                btn.classList.remove('active');
                            }
                        });
                    }
                }
            }
        }
    });

    // Render folders in sidebar
    const renderFolders = async () => {
        const accountEmails = Object.keys(userAccounts).filter(key => !key.startsWith('_'));
        const spaces = JSON.parse(localStorage.getItem('spacesList') || '{}');
        const spaceNames = Object.keys(spaces);

        const folderItems = await Promise.all([
            // Spaces folder
            FolderItem({ folder: { name: "Spaces", icon: "fas fa-users" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            ...(accountEmails.length > 0 ? await Promise.all(accountEmails.map(email =>
                FolderItem({ folder: { email: email, name: email, icon: appState.getAccountIconClass(email) }, isSubfolder: true, accountEmail: email, tagName: null, state: appState })
            )) : []),
            // Spaces subfolders (Create Space, Join Space, accounts, spaces)
            FolderItem({ folder: { name: "Create Space", icon: "fas fa-plus" }, isSubfolder: true, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Join Space", icon: "fas fa-sign-in-alt" }, isSubfolder: true, accountEmail: null, tagName: null, state: appState }),
            // Other folders based on tabs
            FolderItem({ folder: { name: "Chat", icon: "fas fa-comments" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Video Chat", icon: "fas fa-video" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Audio Chat", icon: "fas fa-microphone" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Screen Share", icon: "fas fa-desktop" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Whiteboard", icon: "fas fa-paint-brush" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Kanban", icon: "fas fa-columns" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Documents", icon: "fas fa-file-alt" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Settings", icon: "fas fa-cog" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState }),
            FolderItem({ folder: { name: "Export Workspace", icon: "fas fa-download" }, isSubfolder: false, accountEmail: null, tagName: null, state: appState })
        ]);

        return render({
            tagName: "div",
            children: folderItems
        });
    };

    // Initial render
    document.getElementById("spacesSidebar").replaceChildren(await renderFolders());
    
    // On load, show the main interface with the intro page and hide the setup section.
    document.getElementById('setupSection').classList.add('hidden');
    document.getElementById('inRoomInterface').classList.remove('hidden');
</script>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" style="position:absolute; overflow:hidden" class="hidden">
  <defs>

    <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
      <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise"/>
      <feGaussianBlur in="noise" stdDeviation="2" result="blurred"/>
      <feDisplacementMap in="SourceGraphic" in2="blurred" scale="3" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
    <filter id="glass-highlight" x="0%" y="0%" width="100%" height="100%">
      <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur"/>
      <feSpecularLighting in="blur" result="specOut" lighting-color="#87CEEB" specularConstant="1.5" specularExponent="20">
        <fePointLight x="-5000" y="-10000" z="20000"/>
      </feSpecularLighting>
      <feComposite in="specOut" in2="SourceAlpha" operator="in" result="specOut2"/>
      <feComposite in="SourceGraphic" in2="specOut2" operator="arithmetic" k1="0" k2="1" k3="1" k4="0"/>
    </filter>
    
    <linearGradient id="aurora-blue-green" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00D4FF;stop-opacity:0.8" />
      <stop offset="33%" style="stop-color:#5DADE2;stop-opacity:0.6" />
      <stop offset="66%" style="stop-color:#58D68D;stop-opacity:0.6" />
      <stop offset="100%" style="stop-color:#7DCEA0;stop-opacity:0.8" />
    </linearGradient>
    
    <radialGradient id="bubble-gradient" cx="30%" cy="30%" r="70%">
      <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:0.8" />
      <stop offset="70%" style="stop-color:#87CEEB;stop-opacity:0.4" />
      <stop offset="100%" style="stop-color:#5DADE2;stop-opacity:0.2" />
    </radialGradient>
  </defs>
</svg>
<div class="container">
    <div class="app-header">
        <div class="app-header-title-group">
            <h1>Spaces</h1>
            <button id="cycleThemeBtn" class="btn btn-outline theme-cycle-button" onclick="cycleTheme()">
                <span class="icon">🎨</span>
                <span id="currentThemeNameSpan">Light</span>
            </button>
        </div>
    </div>

    <div id="setupSection" class="setup-controls-container card hidden">
        <label for="nicknameInput">Username:</label>
        <input type="text" id="nicknameInput" placeholder="Enter your username">

        <div class="button-group">
            <button id="createPartyBtn" class="btn">Create Workspace</button>
            <button id="joinWorkspaceBtn" class="btn">Join Workspace</button>
            <button id="importWorkspaceBtn" class="btn">Import Workspace</button>
        </div>

        <div id="createWorkspaceFields" class="hidden">
            <label for="roomPasswordInput">Workspace Password:</label>
            <input type="password" id="roomPasswordInput" placeholder="Enter workspace password">
            <div class="button-group">
                <button id="confirmCreateBtn" class="btn">Create</button>
                <button id="cancelCreateBtn" class="btn">Cancel</button>
            </div>
        </div>

        <div id="joinWorkspaceFields" class="hidden">
            <label for="roomIdInput">Workspace Code:</label>
            <input type="text" id="roomIdInput" placeholder="Enter Room Code">
            <label for="joinPasswordInput">Workspace Password:</label>
            <input type="password" id="joinPasswordInput" placeholder="Enter workspace password">
            <div class="button-group">
                <button id="confirmJoinBtn" class="btn">Join</button>
                <button id="cancelJoinBtn" class="btn">Cancel</button>
            </div>
        </div>

        <input type="file" id="importFilePicker" class="hidden" accept=".spaces_encrypted" onchange="onChangeImportFilePicker(event)">
    </div>


    <div id="inRoomInterface" class="app-wrapper">
        <div class="plugin-container">
            <div class="plugin-sidebar" id="spacesSidebar">
                <!-- Folders will be rendered here -->
            </div>
            <main class="main-app-content plugin-main">
                <div class="header-context-area">
                    <div id="headerRoomInfoDisplay">
                        <p><strong>Workspace:</strong> <span id="currentRoomCodeSpan"></span><button id="copyRoomCodeBtn" class="copy-room-code-btn" title="Copy Room Code" onclick="onClickCopyRoomCodeBtn()">📋</button></p>
                        <p class="room-info-separator">|</p>
                        <p><strong>My Username:</strong> <span id="currentNicknameSpan"></span></p>
                    </div>
                </div>

                <!-- NEW: Intro section shown by default on load -->
                <div id="introSection" class="content-section">
                    <h2>Welcome to Spaces</h2>
                    <p>Spaces is a collaborative workspace plugin that allows you to create and join shared environments for real-time communication and productivity. Here's what you can do:</p>
                    <ul>
                        <li><strong>Chat</strong>: Engage in text-based conversations with channels and private messages.</li>
                        <li><strong>Video/Audio Chat</strong>: Start video or audio calls for face-to-face or voice interactions.</li>
                        <li><strong>Screen Share</strong>: Share your screen with others in the workspace.</li>
                        <li><strong>Whiteboard</strong>: Collaborate on a shared drawing canvas.</li>
                        <li><strong>Kanban</strong>: Organize tasks with a visual board.</li>
                        <li><strong>Documents</strong>: Edit shared documents collaboratively.</li>
                        <li><strong>Settings</strong>: Customize your experience, including audio settings and themes.</li>
                    </ul>
                    <p>To get started, select an account from the sidebar to join an existing space, or choose "Create Space" or "Join Space" to set up a new one. Workspaces are secure and require passwords for access.</p>
                    <p><em>Note: No workspace is active yet—click a folder to begin!</em></p>
                </div>

                <!-- Existing sections remain, but all start hidden except intro -->
                <div id="chatSection" class="content-section hidden">
                    <h2>Chat Room</h2>
                    <div class="chat-section-content">
                        <div class="chat-main section-pane">
                            <div id="chatArea"></div>
                            <!-- NEW: Banner for reply context -->
                            <div id="replyingToBanner" class="replying-to-banner hidden card">
                                <span id="replyingToText"></span>
                                <button id="cancelReplyBtn" title="Cancel Reply">✖</button>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="messageInput" placeholder="Type message or /pm User message">
                                <span id="triggerFileInput" class="file-attach-icon" title="Attach File">📎</span>
                                <input type="file" id="chatFileInput" class="hidden">
                                <span class="emoji-icon">😊</span>
                                <div id="emojiPickerPopup" class="emoji-picker-popup hidden card"></div>
                                <button id="sendMessageBtn" class="btn">Send</button>
                            </div>
                        </div>
                        <div class="chat-sidebar section-pane">
                            <div class="channel-management">
                                <h3>Channels</h3>
                                <div id="channelList" class="channel-list-container card"></div>
                                <div class="add-channel-controls">
                                    <input type="text" id="newChannelNameInput" placeholder="#new-channel-name" maxlength="16">
                                    <button id="addChannelBtn" class="btn">Create Channel</button>
                                </div>
                            </div>
                            <div class="user-list-sidebar">
                                 <h3>Users Online</h3>
                                 <ul id="userList" class="card"></ul> <!-- Individual sliders go in here via JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="videoChatSection" class="content-section hidden section-pane">
                    <h2>Video Chat</h2>
                    <div class="button-group">
                        <button id="startVideoCallBtn" class="btn">Start Video Call</button>
                        <button id="stopVideoCallBtn" class="btn" disabled>Stop Video Call</button>
                        <div style="margin-left: auto; display: flex; align-items: center;">
                            <input type="checkbox" id="toggleLocalVideoPreviewCheckbox" checked style="margin-bottom: 0;">
                            <label for="toggleLocalVideoPreviewCheckbox" style="margin-left: var(--space-xs); margin-bottom: 0;">Show my preview in grid</label>
                        </div>
                    </div>
                    <div id="remoteVideoChatContainer" class="remote-videos-grid">
                    </div>
                </div>

                <div id="audioChatSection" class="content-section hidden section-pane">
                    <h2>Audio Chat</h2>
                    <div class="button-group">
                        <button id="startAudioCallBtn" class="btn">Start Audio Call</button>
                        <button id="stopAudioCallBtn" class="btn" disabled>Stop Audio Call</button>
                    </div>
                    <div id="audioChatStatus" class="hidden" style="padding: var(--space-xs) var(--space-sm); background-color: var(--info-bg); border-left: 2px solid var(--info-border); border-radius: var(--radius-sm); margin-top: var(--space-sm);">
                        Audio call active.
                    </div>
                </div>

                <div id="screenShareSection" class="content-section hidden section-pane">
                    <h2>Shared Content (Screen)</h2>
                    <div class="button-group">
                        <button id="startShareBtn" class="btn">Start Sharing Screen</button>
                        <button id="stopShareBtn" class="btn" disabled>Stop Sharing Screen</button>
                    </div>
                    <div id="localScreenSharePreviewContainer" class="hidden">
                        <h4>My Screen Preview</h4>
                        <video id="localScreenSharePreviewVideo" autoplay muted playsinline></video>
                    </div>
                    <div id="remoteVideosContainer" style="flex-grow: 1; min-height: 0; margin-top: var(--space-md);">
                    </div>
                </div>

                <div id="whiteboardSection" class="content-section hidden section-pane">
                    <h2>Collaborative Whiteboard</h2>
                    <div class="button-group">
                        <div class="wb-tool-palette card">
                            <button class="wb-tool-btn" data-tool="pen" title="Pen">✏️</button>
                            <button class="wb-tool-btn" data-tool="line" title="Line">📏</button>
                            <button class="wb-tool-btn" data-tool="rectangle" title="Rectangle">▭</button>
                            <button class="wb-tool-btn" data-tool="circle" title="Circle">⚪</button>
                            <button class="wb-tool-btn" data-tool="text" title="Text">T</button>
                            <button class="wb-tool-btn" data-tool="eraser" title="Eraser">🧼</button>
                        </div>
                        <label for="wbColorPicker">Color:</label> <input type="color" id="wbColorPicker" value="#000000">
                        <label for="wbLineWidth">Width:</label> <input type="range" id="wbLineWidth" min="1" max="30" value="3">
                        <span id="wbLineWidthValue" style="min-width: 30px; text-align: right;">3px</span>
                        <button id="wbClearBtn" class="btn">Clear Board</button>
                        <button id="wbExportPngBtn" class="btn">Export PNG</button>
                    </div>
                    <div id="wbTextInputArea" class="hidden">
                        <input type="text" id="wbActualTextInput" placeholder="Enter text...">
                        <button id="wbSubmitTextBtn" class="btn">Add Text</button>
                    </div>
                    <div class="whiteboard-canvas-container">
                        <canvas id="whiteboardCanvas" width="640" height="360"></canvas>
                    </div>
                </div>

                <div id="kanbanSection" class="content-section hidden section-pane">
                    <h2>Kanban Board</h2>
                    <div class="button-group">
                        <input type="text" id="newColumnNameInput" placeholder="New column name">
                        <button id="addColumnBtn" class="btn">Add Column</button>
                    </div>
                    <div id="kanbanBoard" class="kanban-board card"></div>
                </div>

                <div id="documentsSection" class="content-section hidden section-pane">
                    <h2>Collaborative Documents</h2>
                    <div class="document-management-bar card">
                        <h3>Documents:</h3>
                        <div id="documentList"></div>
                        <div class="document-actions" style="display: flex; gap: var(--space-sm); margin-left: auto;">
                            <button id="newDocBtn" class="btn" title="New Document">New Doc</button>
                            <button id="renameDocBtn" class="btn" title="Rename Current Document">Rename</button>
                            <button id="deleteDocBtn" class="btn-danger" title="Delete Current Document">Delete</button>
                        </div>
                    </div>
                    <div class="document-formatting-controls card button-group">
                        <button id="docBoldBtn" class="btn" title="Bold"><b>B</b></button>
                        <button id="docItalicBtn" class="btn" title="Italic"><i>I</i></button>
                        <button id="docUnderlineBtn" class="btn" title="Underline"><u>U</u></button>
                        <button id="docUlBtn" class="btn" title="Unordered List">UL</button>
                        <button id="docOlBtn" class="btn" title="Ordered List">OL</button>
                        <button id="downloadTxtBtn" class="btn">Download as text</button>
                        <button id="printDocBtn" class="btn" title="Print to PDF">Print PDF</button>
                    </div>
                    <div id="collaborativeEditor" contenteditable="true" spellcheck="false" class="card"></div>
                </div>

                <div id="settingsSection" class="content-section hidden section-pane card">
                    <h2>Settings</h2>
                    
                    <label for="settingsNicknameInput">Username:</label>
                    <input type="text" id="settingsNicknameInput" style="margin-bottom: var(--space-md);">

                    <div class="settings-option">
                        <input type="checkbox" id="settingsVideoFlipCheckbox">
                        <label for="settingsVideoFlipCheckbox">Flip my video horizontally</label>
                    </div>

                    <div class="settings-option">
                        <input type="checkbox" id="settingsPttEnabledCheckbox" onchange="onChangeSettingsPttEnabled()">
                        <label for="settingsPttEnabledCheckbox">Enable Push-to-Talk (Audio Chat)</label>
                    </div>
                    
                    <div id="pttHotkeySettingsContainer" class="settings-option hidden" style="align-items: baseline;">
                        <label for="settingsPttKeyBtn" style="margin-right: var(--space-sm); white-space: nowrap;">Hotkey:</label>
                        <div>
                            <button id="settingsPttKeyBtn" class="btn btn-outline" onclick="onClickSettingsPttKey()">Space</button>
                            <span id="pttKeyInstructions" class="hidden">Press any key... (Esc to cancel)</span>
                        </div>
                    </div>

                    <div class="settings-option">
                        <label for="settingsGlobalVolumeSlider" style="white-space: nowrap;">Global Audio Volume:</label>
                        <input type="range" id="settingsGlobalVolumeSlider" min="0" max="1" step="0.01" value="1" style="flex-grow: 1; margin-bottom:0;" oninput="onInputSettingsGlobalVolume()">
                        <span id="globalVolumeValue" style="min-width: 40px; text-align: right;">100%</span>
                    </div>

                    <div class="settings-actions">
                        <button id="settingsSaveBtn" class="btn" onclick="onClickSettingsSave()">Save Settings</button>
                    </div>
                </div>

            </main>
        </div>
    </div>
</div>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .catch(err => console.log('SW registration failed'));
}
</script>
<iframe id="printFrame" style="display: none;"></iframe>
<script type="module" src="main.js"></script>
</body>
</html>