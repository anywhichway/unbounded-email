<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="../index.css">
        <link rel="stylesheet" href="./index.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script src="../../assets/js/lightview-core.js"></script>
        <script src="../../assets/js/lightview-dom.js"></script>
        <script src="../../assets/js/lightview-href.js"></script>
        <script src="../../assets/js/lightview-iframe.js"></script>
        <script src="./index.js"></script>
    </head>
    <body>
        <div id="app"></div>
         <script type="module" id="init">
            const {render} = Lightview;
            const {local} = lvIFrame;
            const {user, ui} = await local(lvIFrame.import("./"));

            let events = [];
            let filteredEvents = [];
            let currentFilterType = 'folder';
            let currentFilterValue = 'All Calendars';
            let currentDate = new Date();
            let currentTag = null;
            let currentAccount = null;
            window.selectedFolderId = 'folder-All Calendars';

            const getHeaderTitle = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = currentDate.toLocaleString('default', { month: 'long' });
                
                let title = `${monthName} ${year}`;
                
                if (currentTag) {
                    if (currentAccount) {
                        title += ` - ${currentAccount} - Categories - ${currentTag}`;
                    } else {
                        title += ` - Categories - ${currentTag}`;
                    }
                } else if (currentAccount) {
                    if (currentFilterType === 'starred') {
                        title += ` - ${currentAccount} - Starred`;
                    } else {
                        title += ` - ${currentAccount}`;
                    }
                } else if (currentFilterType === 'starred') {
                    title += ` - Starred`;
                }
                
                return title;
            };

            const applyFilters = () => {
                if (currentFilterType === 'account') {
                    if (currentFilterValue) {
                        filteredEvents = events.filter(e => e.sourceAccount === currentFilterValue);
                    } else {
                        filteredEvents = events;
                    }
                } else if (currentFilterType === 'tag') {
                    if (currentAccount) {
                        filteredEvents = events.filter(e => e.sourceAccount === currentAccount && e.tags && e.tags.includes(currentTag));
                    } else {
                        filteredEvents = events.filter(e => e.tags && e.tags.includes(currentTag));
                    }
                } else if (currentFilterType === 'starred') {
                    if (currentAccount) {
                        filteredEvents = events.filter(e => e.sourceAccount === currentAccount && e.starred);
                    } else {
                        filteredEvents = events.filter(e => e.starred);
                    }
                } else {
                    if (currentAccount) {
                        filteredEvents = events.filter(e => e.sourceAccount === currentAccount);
                    } else {
                        filteredEvents = events;
                    }
                }
            };

            const renderCalendar = async () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = currentDate.toLocaleString('default', { month: 'long' });

                events = await getEventsFromAccounts(user, year);
                applyFilters();

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                const firstDayOfWeek = firstDayOfMonth.getDay();
                const totalDays = lastDayOfMonth.getDate();

                const days = [];
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => ({
                    tagName: 'div',
                    attributes: { class: 'calendar-day-header' },
                    children: [day]
                }));

                for (let i = 0; i < firstDayOfWeek; i++) {
                    days.push({ tagName: 'div', attributes: { class: 'calendar-day empty' } });
                }

                for (let day = 1; day <= totalDays; day++) {
                    const date = new Date(year, month, day);
                    const today = new Date();
                    const isToday = date.toDateString() === today.toDateString();

                    const dayEvents = filteredEvents.filter(event => {
                        const [yearStr, monthStr, dayStr] = event.date.split('-');
                        const eventDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));
                        return eventDate.getFullYear() === year &&
                               eventDate.getMonth() === month &&
                               eventDate.getDate() === day;
                    });

                    days.push({
                        tagName: 'div',
                        attributes: { class: `calendar-day ${isToday ? 'today' : ''}` },
                        children: [
                            {
                                tagName: 'div',
                                attributes: { class: 'day-number' },
                                children: [day.toString()]
                            },
                            ...dayEvents.map(event => ({
                                tagName: 'div',
                                attributes: { class: `calendar-event ${event.starred ? 'starred' : ''}` },
                                children: [
                                    event.starred ? {
                                        tagName: 'i',
                                        attributes: { class: 'fas fa-star event-star' }
                                    } : null,
                                    event.title
                                ].filter(Boolean)
                            }))
                        ]
                    });
                }

                const userAccounts = user.accounts || {};
                const accountEmails = Object.keys(userAccounts);
                const tags = [...new Set(events.flatMap(e => e.tags || []))];
                const tagIcons = ui.tagIcons || {};

                const folders = [
                    { 
                        name: "All Calendars", 
                        icon: "fas fa-calendar-alt", 
                        count: events.length,
                        subfolders: accountEmails.map(email => ({
                            email: email,
                            name: email,
                            count: events.filter(e => e.sourceAccount === email).length
                        }))
                    },
                    { 
                        name: "Starred", 
                        icon: "fas fa-star",
                        count: events.filter(e => e.starred).length
                    },
                    { 
                        name: "Categories", 
                        icon: "fas fa-tags",
                        subfolders: tags.map(tag => ({
                            name: tag.slice(1).charAt(0).toUpperCase() + tag.slice(2),
                            originalTag: tag,
                            icon: tagIcons[tag] || tagIcons.default,
                            count: events.filter(e => e.tags && e.tags.includes(tag)).length
                        }))
                    }
                ];

                const folderItems = [];
                folders.forEach(folder => {
                    folderItems.push(createFolderItem(folder));
                    
                    if (folder.subfolders && folder.subfolders.length > 0) {
                        folder.subfolders.forEach(subfolder => {
                            if (folder.name === "All Calendars") {
                                folderItems.push(createFolderItem(subfolder, true, subfolder.email));
                            } else {
                                folderItems.push(createFolderItem(subfolder, true, null, subfolder.originalTag));
                            }
                        });
                    }
                });

                // Update folder counts based on current account selection
                document.querySelectorAll('.folder-item').forEach(item => {
                    const countEl = item.querySelector('.folder-count');
                    if (countEl) {
                        const accountEmail = item.getAttribute('data-account');
                        const folderName = item.getAttribute('data-folder');
                        const categoryName = item.getAttribute('data-category');
                        
                        let count = 0;
                        if (accountEmail && accountEmail !== "") {
                            // Account events
                            count = events.filter(e => e.sourceAccount === accountEmail).length;
                        } else if (folderName && folderName !== "") {
                            // Top-level folder
                            if (folderName === 'Starred') {
                                if (currentAccount) {
                                    count = events.filter(e => e.sourceAccount === currentAccount && e.starred).length;
                                } else {
                                    count = events.filter(e => e.starred).length;
                                }
                            } else if (folderName === 'All Calendars') {
                                if (currentAccount) {
                                    count = events.filter(e => e.sourceAccount === currentAccount).length;
                                } else {
                                    count = events.length;
                                }
                            }
                        } else if (categoryName) {
                            // Category
                            if (currentAccount) {
                                count = events.filter(e => e.sourceAccount === currentAccount && e.tags && e.tags.includes(categoryName)).length;
                            } else {
                                count = events.filter(e => e.tags && e.tags.includes(categoryName)).length;
                            }
                        }
                        countEl.textContent = count.toString();
                    }
                });

                // Update visual selection
                document.querySelectorAll('.folder-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (window.selectedFolderId) {
                    const selectedItem = document.getElementById(window.selectedFolderId);
                    if (selectedItem) {
                        selectedItem.classList.add('active');
                    }
                }
                
                // Also keep account selection active if we're filtering within an account
                if (currentAccount) {
                    const accountItem = document.getElementById(`account-${currentAccount.replace('@', '-at-')}`);
                    if (accountItem) {
                        accountItem.classList.add('active');
                    }
                }

                const calendarWrapper = document.querySelector('.calendar-wrapper');
                
                if (calendarWrapper) {
                    const sidebar = document.querySelector('.calendar-sidebar');
                    render({
                        tagName: 'div',
                        attributes: { class: 'calendar-sidebar' },
                        children: folderItems
                    }, {replaceEl: sidebar});

                    const currentCalendarGrid = calendarWrapper.querySelector('.calendar-grid');
                    const currentCalendarHeader = calendarWrapper.querySelector('.plugin-header');
                    
                    render({
                        tagName: 'div',
                        attributes: { class: 'plugin-header' },
                        children: [
                           {
                                tagName: 'h1',
                                children: [getHeaderTitle()]
                           },
                           {
                                tagName: 'input',
                                attributes: { 
                                    type: 'date',
                                    class: 'date-picker',
                                    value: currentDate.toISOString().split('T')[0],
                                    onchange: 'updateDate(this)'
                                }
                            }
                        ]
                    }, { replaceEl: currentCalendarHeader });

                    render({
                        tagName: 'div',
                        attributes: { class: 'calendar-grid' },
                        children: [...dayHeaders, ...days]
                    }, { replaceEl: currentCalendarGrid });

                    // Apply visual selection and count updates for existing calendar
                    setTimeout(() => {
                        // Update folder counts based on current account selection
                        document.querySelectorAll('.folder-item').forEach(item => {
                            const countEl = item.querySelector('.folder-count');
                            if (countEl) {
                                const accountEmail = item.getAttribute('data-account');
                                const folderName = item.getAttribute('data-folder');
                                const categoryName = item.getAttribute('data-category');
                                
                                let count = 0;
                                if (accountEmail && accountEmail !== "") {
                                    // Account events
                                    count = events.filter(e => e.sourceAccount === accountEmail).length;
                                } else if (folderName && folderName !== "") {
                                    // Top-level folder
                                    if (folderName === 'Starred') {
                                        if (currentAccount) {
                                            count = events.filter(e => e.sourceAccount === currentAccount && e.starred).length;
                                        } else {
                                            count = events.filter(e => e.starred).length;
                                        }
                                    } else if (folderName === 'All Calendars') {
                                        if (currentAccount) {
                                            count = events.filter(e => e.sourceAccount === currentAccount).length;
                                        } else {
                                            count = events.length;
                                        }
                                    }
                                } else if (categoryName) {
                                    // Category
                                    if (currentAccount) {
                                        count = events.filter(e => e.sourceAccount === currentAccount && e.tags && e.tags.includes(categoryName)).length;
                                    } else {
                                        count = events.filter(e => e.tags && e.tags.includes(categoryName)).length;
                                    }
                                }
                                countEl.textContent = count.toString();
                            }
                        });

                        // Update visual selection
                        document.querySelectorAll('.folder-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        if (window.selectedFolderId) {
                            const selectedItem = document.getElementById(window.selectedFolderId);
                            if (selectedItem) {
                                selectedItem.classList.add('active');
                            }
                        }
                        
                        // Also keep account selection active if we're filtering within an account
                        if (currentAccount) {
                            const accountItem = document.getElementById(`account-${currentAccount.replace('@', '-at-')}`);
                            if (accountItem) {
                                accountItem.classList.add('active');
                            }
                        }
                    }, 0);
                    
                    return;
                }

                render({
                    tagName: 'div',
                    attributes: { class: 'plugin-wrapper' },
                    children: [
                        {
                            tagName: 'div',
                            attributes: { class: 'plugin-header' },
                            children: [
                                {
                                    tagName: 'h1',
                                    children: [getHeaderTitle()]
                                },
                                {
                                    tagName: 'input',
                                    attributes: { 
                                        type: 'date',
                                        class: 'date-picker',
                                        value: currentDate.toISOString().split('T')[0],
                                        onchange: 'updateDate(this)'
                                    }
                                }
                            ]
                        },
                        {
                            tagName: 'div',
                            attributes: { class: 'plugin-container' },
                            children: [
                                {
                                    tagName: 'div',
                                    attributes: { class: 'plugin-sidebar' },
                                    children: folderItems
                                },
                                {
                                    tagName: 'div',
                                    attributes: { class: 'plugin-main' },
                                    children: [
                                        {
                                            tagName: 'div',
                                            attributes: { class: 'calendar-grid' },
                                            children: [...dayHeaders, ...days]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }, { replaceEl: document.getElementById('app') });
                
                // Apply initial visual selection and count updates
                setTimeout(() => {
                    // Update folder counts based on current account selection
                    document.querySelectorAll('.folder-item').forEach(item => {
                        const countEl = item.querySelector('.folder-count');
                        if (countEl) {
                            const accountEmail = item.getAttribute('data-account');
                            const folderName = item.getAttribute('data-folder');
                            const categoryName = item.getAttribute('data-category');
                            
                            let count = 0;
                            if (accountEmail && accountEmail !== "") {
                                // Account events
                                count = events.filter(e => e.sourceAccount === accountEmail).length;
                            } else if (folderName && folderName !== "") {
                                // Top-level folder
                                if (folderName === 'Starred') {
                                    if (currentAccount) {
                                        count = events.filter(e => e.sourceAccount === currentAccount && e.starred).length;
                                    } else {
                                        count = events.filter(e => e.starred).length;
                                    }
                                } else if (folderName === 'All Calendars') {
                                    if (currentAccount) {
                                        count = events.filter(e => e.sourceAccount === currentAccount).length;
                                    } else {
                                        count = events.length;
                                    }
                                }
                            } else if (categoryName) {
                                // Category
                                if (currentAccount) {
                                    count = events.filter(e => e.sourceAccount === currentAccount && e.tags && e.tags.includes(categoryName)).length;
                                } else {
                                    count = events.filter(e => e.tags && e.tags.includes(categoryName)).length;
                                }
                            }
                            countEl.textContent = count.toString();
                        }
                    });

                    // Update visual selection
                    document.querySelectorAll('.folder-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    if (window.selectedFolderId) {
                        const selectedItem = document.getElementById(window.selectedFolderId);
                        if (selectedItem) {
                            selectedItem.classList.add('active');
                        }
                    }
                    
                    // Also keep account selection active if we're filtering within an account
                    if (currentAccount) {
                        const accountItem = document.getElementById(`account-${currentAccount.replace('@', '-at-')}`);
                        if (accountItem) {
                            accountItem.classList.add('active');
                        }
                    }
                }, 0);
            };

            window.updateDate = (element) => {
                const [year, month, day] = element.value.split('-').map(Number);
                currentDate = new Date(year, month - 1, day);
                renderCalendar();
            };

            window.filterEventsByAccount = (accountEmail) => {
                currentFilterType = 'account';
                currentFilterValue = accountEmail;
                currentAccount = accountEmail;
                currentTag = null;
                window.selectedFolderId = accountEmail ? `account-${accountEmail.replace('@', '-at-')}` : 'folder-All Calendars';
                renderCalendar();
            };

            window.filterEventsByFolder = (folderName) => {
                currentTag = null;
                const lowerCaseFolderName = folderName.toLowerCase();
                
                if (lowerCaseFolderName === 'all calendars') {
                    // When clicking on All Calendars, show all events and reset account filter
                    currentFilterType = 'folder';
                    currentFilterValue = folderName;
                    currentAccount = null;
                } else if (lowerCaseFolderName === 'starred') {
                    currentFilterType = 'starred';
                    currentFilterValue = null;
                } else {
                    currentFilterType = 'folder';
                    currentFilterValue = folderName;
                }
                window.selectedFolderId = `folder-${folderName}`;
                renderCalendar();
            };

            window.filterEventsByTag = (tagName) => {
                currentFilterType = 'tag';
                currentTag = tagName;
                window.selectedFolderId = `category-${tagName}`;
                renderCalendar();
            }

            renderCalendar();
        </script>
    </body>
</html>
