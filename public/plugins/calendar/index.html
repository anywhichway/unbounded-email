<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Unbounded: Calendar</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="../index.css">
        <link rel="stylesheet" href="./index.css">
        <script src="../../assets/js/lightview.js"></script>
        <script>
            const lightview = Lightview("browser");
            const {render, state, navigate} = Lightview("browser");
        </script>
        <script src="./index.js"></script>
        <script src="./calendar.js"></script>
        <script src="./events.js"></script>
        <script src="../folder-item.js"></script>
    </head>
    <body>
         <script type="module" id="init">
            const {user, ui} = await lightview.import("./");

            const getAccountIconClass = (accountEmail) => {
                const account = user.accounts[accountEmail];
                const accountType = account?.type;
                return ui.accountIcons?.[accountType] || ui.accountIcons?.default || 'fas fa-envelope';
            };

            const events = getEventsFromAccounts(user);

            // Get user accounts from user structure
            const userAccounts = user.accounts || {};
            const accountEmails = Object.keys(user?.accounts || {}).filter(key => !key.startsWith('_'));

            // Get unique tags from events
            const tags = [...new Set(events.flatMap(e => e.tags || []))];
            const tagIcons = {
                ...ui.tagIcons,
                snoozed: "fas fa-clock",
                scheduled: "fas fa-calendar-alt",
                "contact-reachout": "fas fa-user-friends"
            };

            const getCalendarCount = ({ folder, accountEmail, tagName, appState }) => {
                let count = 0;
                if (accountEmail) {
                    count = appState.events.filter(e => e.sourceAccount === accountEmail).length;
                } else if (tagName) {
                    let eventsToCheck = appState.currentAccount ?
                        appState.events.filter(e => e.sourceAccount === appState.currentAccount) :
                        appState.events;
                    count = eventsToCheck.filter(e => e.tags && e.tags.includes(tagName)).length;
                } else if (folder.name === "All Calendars") {
                    count = appState.events.length;
                }
                return count;
            };

            // Reactive state for filtering and UI
            const appState = state({
                events: events,
                tagIcons: tagIcons,
                currentAccount: null,
                currentTag: null,
                currentFolder: null,
                selectedFolderId: 'folder-All Calendars',
                currentView: 'monthly',
                currentDate: new Date(),
                selectedDate: new Date(),
                getCount: getCalendarCount,
                getAccountIconClass,
                get filteredEvents() {
                    let filtered = this.events;

                    // First filter by account if one is selected
                    if (this.currentAccount) {
                        filtered = filtered.filter(e => e.sourceAccount === this.currentAccount);
                    }

                    // Then apply additional filters based on current selection
                    if (this.currentTag) {
                        filtered = filtered.filter(e => e.tags && e.tags.includes(this.currentTag));
                    } else if (this.currentFolder) {
                        const lowerCaseFolder = this.currentFolder.toLowerCase();
                        // Add folder-based filtering logic here if needed
                    }

                    // Filter by current date range based on view
                    const currentYear = this.currentDate.getFullYear();
                    const currentMonth = this.currentDate.getMonth();

                    if (this.currentView === 'monthly') {
                        const startOfMonth = new Date(currentYear, currentMonth, 1);
                        const endOfMonth = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);

                        filtered = filtered.filter(event => {
                            const eventStart = new Date(event.startDate);
                            const eventEnd = new Date(event.endDate);
                            return eventStart <= endOfMonth && eventEnd >= startOfMonth;
                        });
                    } else if (this.currentView === 'weekly') {
                        const weekStart = new Date(this.currentDate);
                        weekStart.setDate(this.currentDate.getDate() - this.currentDate.getDay());
                        weekStart.setHours(0, 0, 0, 0);

                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        weekEnd.setHours(23, 59, 59, 999);

                        filtered = filtered.filter(event => {
                            const eventStart = new Date(event.startDate);
                            const eventEnd = new Date(event.endDate);
                            return eventStart <= weekEnd && eventEnd >= weekStart;
                        });
                    } else if (this.currentView === 'quarterly') {
                        const quarter = Math.floor(currentMonth / 3);
                        const startOfQuarter = new Date(currentYear, quarter * 3, 1);
                        const endOfQuarter = new Date(currentYear, (quarter + 1) * 3, 0, 23, 59, 59, 999);

                        filtered = filtered.filter(event => {
                            const eventStart = new Date(event.startDate);
                            const eventEnd = new Date(event.endDate);
                            return eventStart <= endOfQuarter && eventEnd >= startOfQuarter;
                        });
                    }

                    return filtered;
                },
                selectFolder(folderType, value) {
                    if (folderType === 'account') {
                        this.currentAccount = value;
                        this.currentTag = null;
                        this.currentFolder = null;
                        this.selectedFolderId = value ? `account-${value.replace('@', '-at-')}` : 'folder-All Calendars';
                    } else if (folderType === 'tag') {
                        this.currentTag = value;
                        this.currentFolder = null;
                        this.selectedFolderId = `category-${value}`;
                    } else if (folderType === 'folder') {
                        this.currentFolder = value;
                        this.currentTag = null;
                        if (value === 'All Calendars') {
                            this.currentAccount = null;
                        }
                        this.selectedFolderId = `folder-${value}`;
                    }
                },
                get headerTitle() {
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();
                    const monthName = this.currentDate.toLocaleString('default', { month: 'long' });

                    let title = `${monthName} ${year}`;

                    if (this.currentView === 'weekly') {
                        const weekStart = new Date(this.currentDate);
                        weekStart.setDate(this.currentDate.getDate() - this.currentDate.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);

                        const startMonth = weekStart.toLocaleString('default', { month: 'short' });
                        const endMonth = weekEnd.toLocaleString('default', { month: 'short' });

                        if (startMonth === endMonth) {
                            title = `${startMonth} ${weekStart.getDate()}-${weekEnd.getDate()}, ${year}`;
                        } else {
                            title = `${startMonth} ${weekStart.getDate()} - ${endMonth} ${weekEnd.getDate()}, ${year}`;
                        }
                    } else if (this.currentView === 'quarterly') {
                        const quarter = Math.floor(month / 3) + 1;
                        title = `Q${quarter} ${year}`;
                    }

                    return title;
                },
                navigatePrevious() {
                    if (this.currentView === 'weekly') {
                        this.currentDate.setDate(this.currentDate.getDate() - 7);
                    } else if (this.currentView === 'monthly') {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    } else if (this.currentView === 'quarterly') {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 3);
                    }
                },
                navigateNext() {
                    if (this.currentView === 'weekly') {
                        this.currentDate.setDate(this.currentDate.getDate() + 7);
                    } else if (this.currentView === 'monthly') {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    } else if (this.currentView === 'quarterly') {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 3);
                    }
                },
                renderCalendarView() {
                    // Basic monthly calendar view
                    if (this.currentView === 'monthly') {
                        const year = this.currentDate.getFullYear();
                        const month = this.currentDate.getMonth();

                        const firstDayOfMonth = new Date(year, month, 1);
                        const lastDayOfMonth = new Date(year, month + 1, 0);
                        const firstDayOfWeek = firstDayOfMonth.getDay();
                        const totalDays = lastDayOfMonth.getDate();

                        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => ({
                            tagName: 'div',
                            attributes: { class: 'calendar-day-header' },
                            children: [day]
                        }));

                        const days = [];

                        // Empty cells for days before the first day of the month
                        for (let i = 0; i < firstDayOfWeek; i++) {
                            days.push({
                                tagName: 'div',
                                attributes: { class: 'calendar-day empty' }
                            });
                        }

                        // Days of the month
                        for (let day = 1; day <= totalDays; day++) {
                            const date = new Date(year, month, day);
                            const today = new Date();
                            const isToday = date.toDateString() === today.toDateString();

                            const dayEvents = this.filteredEvents.filter(event => {
                                const eventStart = new Date(event.startDate);
                                const eventEnd = new Date(event.endDate);

                                // Set time to start/end of day for comparison
                                const dayStart = new Date(date);
                                dayStart.setHours(0, 0, 0, 0);
                                const dayEnd = new Date(date);
                                dayEnd.setHours(23, 59, 59, 999);

                                // Check if event overlaps with this day
                                return eventStart <= dayEnd && eventEnd >= dayStart;
                            });

                            days.push({
                                tagName: 'div',
                                attributes: {
                                    class: `calendar-day ${isToday ? 'today' : ''}`,
                                    onclick: () => {
                                        this.selectedDate = new Date(date);
                                    }
                                },
                                children: [
                                    {
                                        tagName: 'div',
                                        attributes: { class: 'day-number' },
                                        children: [day.toString()]
                                    },
                                    ...dayEvents.slice(0, 3).map(event => ({
                                        tagName: 'div',
                                        attributes: {
                                            class: 'calendar-event',
                                            style: `background-color: ${event.color}`
                                        },
                                        children: [event.title]
                                    })),
                                    ...(dayEvents.length > 3 ? [{
                                        tagName: 'div',
                                        attributes: { class: 'more-events' },
                                        children: [`+${dayEvents.length - 3} more`]
                                    }] : [])
                                ]
                            });
                        }

                        return {
                            tagName: 'div',
                            attributes: { class: 'calendar-grid' },
                            children: [...dayHeaders, ...days]
                        };
                    }

                    // Placeholder for other views
                    return {
                        tagName: "div",
                        attributes: { class: "calendar-placeholder" },
                        children: [`${this.currentView} view - ${this.headerTitle}`]
                    };
                }
            });

            // Prepare folder data for dynamic generation
            const folderData = {
                accountEmails,
                tags,
                tagIcons
            };

            document.getElementById("init").replaceWith(await Calendar(appState, folderData, user))
        </script>
    </body>
</html>
