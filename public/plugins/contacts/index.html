<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Unbounded: Contacts</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="../index.css">
        <link rel="stylesheet" href="./index.css">
        <!--script src="../../assets/js/lightview-iframe.js"></script-->
        <script src="../../assets/js/lightview.js"></script>
        <script>
            const lightview = Lightview("browser");
            const {render, state, navigate} = lightview;
        </script>
        <script src="./index.js"></script>
        <script src="./contact.js"></script>
        <script src="./contacts.js"></script>
        <script src="./compose-contact.js"></script>
        <script src="../folder-item.js"></script>
    </head>
    <body>
         <script type="module" id="init">
            const {user, ui} = await lightview.import("../", { publish: true, subscribe: true});
            
            const getAccountIconClass = (accountEmail) => {
                const account = user.accounts[accountEmail];
                const accountType = account?.type;
                return ui.accountIcons?.[accountType] || ui.accountIcons?.default || 'fas fa-envelope';
            };
            
            // Get user accounts from user structure
            const userAccounts = user.accounts || {};

            // Get unique tags from contacts (computed dynamically)
            const tagIcons = ui.tagIcons || {};
            
            // Reactive state for filtering and UI
            const appState = state({
                tagIcons: tagIcons,
                user: user,
                currentAccount: null,
                currentTag: null,
                currentFolder: null,
                selectedFolderId: 'folder-All Contacts',
                editingContact: null,
                filteredContacts: [], // Will be computed from user.accounts (references, no copies)
                getCount: getContactsCount,
                getAccountIconClass,
                selectFolder(folderType, value) {
                    if (folderType === 'account') {
                        appState.currentAccount = value;
                        appState.currentTag = null;
                        appState.currentFolder = null;
                        appState.selectedFolderId = value ? `account-${value.replace('@', '-at-')}` : 'folder-All Contacts';
                    } else if (folderType === 'tag') {
                        appState.currentTag = value;
                        appState.currentFolder = null;
                        appState.selectedFolderId = `category-${value}`;
                    } else if (folderType === 'folder') {
                        appState.currentFolder = value;
                        appState.currentTag = null;
                        if (value === 'All Contacts') {
                            appState.currentAccount = null;
                        }
                        appState.selectedFolderId = `folder-${value}`;
                    }
                    // Update filtered contacts after selection change
                    updateFilteredContacts(appState);
                }
            });
            appState.user.tagIcons = JSON.parse(JSON.stringify(tagIcons)); // Ensure reactivity by breaking references
            appState.user.testChange = (user.testChange || 0) + 1; // Dummy property to trigger reactivity

            // Initial setup - compute filtered contacts
            updateFilteredContacts(appState);

            document.getElementById("init").replaceWith(await Contacts(appState))
        </script>
    </body>
</html>
