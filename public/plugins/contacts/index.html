<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Unbounded: Contacts</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="../index.css">
        <link rel="stylesheet" href="./index.css">
        <script src="../../assets/js/lightview-iframe.js"></script>
        <script src="../../assets/js/baux-browser.js"></script>
        <script>const {render, state} = Baux("browser");</script>
        <script src="./index.js"></script>
        <script src="./contact.js"></script>
        <script src="./contacts.js"></script>
        <script src="./folder-item.js"></script>
    </head>
    <body>
         <script type="module" id="init">
            const {local} = lvIFrame;
            const {user, ui, navigate} = await local(lvIFrame.import("./"));
            
            const contacts = getContactsFromAccounts(user);
            
            // Get user accounts from user structure
            const userAccounts = user.accounts || {};
            const accountEmails = Object.keys(userAccounts);

            // Get unique tags from contacts
            const tags = [...new Set(contacts.flatMap(c => c.tags || []))];
            const tagIcons = ui.tagIcons || {};

            // Reactive state for filtering and UI
            const appState = state({
                contacts: contacts,
                tagIcons: tagIcons,
                user: user,
                currentAccount: null,
                currentTag: null,
                currentFolder: null,
                selectedFolderId: 'folder-All Contacts',
                editingContact: null,
                get filteredContacts() {
                    let filtered = this.contacts;
                    
                    // First filter by account if one is selected
                    if (this.currentAccount) {
                        filtered = filtered.filter(c => c.sourceAccount === this.currentAccount);
                    }
                    
                    // Then apply additional filters based on current selection
                    if (this.currentTag) {
                        filtered = filtered.filter(c => c.tags && c.tags.includes(this.currentTag));
                    } else if (this.currentFolder) {
                        const lowerCaseFolder = this.currentFolder.toLowerCase();
                        switch (lowerCaseFolder) {
                            case 'starred':
                                filtered = filtered.filter(c => c.starred);
                                break;
                            case 'frequently contacted':
                                filtered = filtered.filter(c => c.frequentlyContacted);
                                break;
                            case 'scheduled':
                                filtered = filtered.filter(c => c.scheduled);
                                break;
                            default:
                                break;
                        }
                    }
                    
                    return filtered;
                },
                selectFolder(folderType, value) {
                    if (folderType === 'account') {
                        appState.currentAccount = value;
                        appState.currentTag = null;
                        appState.currentFolder = null;
                        appState.selectedFolderId = value ? `account-${value.replace('@', '-at-')}` : 'folder-All Contacts';
                    } else if (folderType === 'tag') {
                        appState.currentTag = value;
                        appState.currentFolder = null;
                        appState.selectedFolderId = `category-${value}`;
                    } else if (folderType === 'folder') {
                        appState.currentFolder = value;
                        appState.currentTag = null;
                        if (value === 'All Contacts') {
                            appState.currentAccount = null;
                        }
                        appState.selectedFolderId = `folder-${value}`;
                    }
                }
            });

            // Prepare folder data for dynamic generation
            const folderData = {
                accountEmails,
                tags: [],
                tagIcons: {}
            };

            document.getElementById("init").replaceWith(await Contacts(appState, folderData))
        </script>
    </body>
</html>
