<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Unbounded: Email</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="../index.css">
        <link rel="stylesheet" href="./index.css">
        <script src="../../assets/js/lightview.js"></script>
        <script>
            const lightview = Lightview("browser");
            const {render, state, navigate} = lightview;
        </script>
        <script src="./index.js"></script>
        <script src="./emails.js"></script>
        <script src="./email.js"></script>
        <script src="../folder-item.js"></script>
    </head>
    <body>
         <script type="module" id="init">
            const {user, ui} = await lightview.import("./", { publish: true, subscribe: true });  // Added subscribe: true for reactivity

            const getAccountIconClass = (accountEmail) => {
                const account = user.accounts[accountEmail];
                const accountType = account?.type;
                return ui.accountIcons?.[accountType] || ui.accountIcons?.default || 'fas fa-envelope';
            };

            // Removed: const emails = getEmailsFromAccounts(user);

            // Get user accounts from user structure
            const userAccounts = user.accounts || {};
            
            // Get unique tags from emails (now computed reactively via getter)
            const tags = [...new Set(getEmailsFromAccounts(user).flatMap(e => e.tags || []))];  // Temporary for initial tags; will be reactive via getter
            const tagIcons = ui.tagIcons || {};

            const getEmailCount = ({ folder, accountEmail, tagName, appState }) => {
                let count = 0;
                const allEmails = appState.emails;

                if (tagName) {
                    count = allEmails.filter(email => {
                        if (appState.currentAccount && email.sourceAccount !== appState.currentAccount) {
                            return false;
                        }
                        if (tagName === 'starred') return email.starred;
                        if (tagName === 'snoozed') return email.snoozed;
                        if (tagName === 'scheduled') return email.scheduled;
                        return email.tags && email.tags.includes(tagName);
                    }).length;
                } else if (accountEmail) {
                    count = allEmails.filter(email => email.sourceAccount === accountEmail).length;
                } else {
                    const folderName = folder.name;
                    count = allEmails.filter(email => {
                        if (appState.currentAccount && email.sourceAccount !== appState.currentAccount) {
                            return false;
                        }
                        return email.folder === folderName;
                    }).length;
                }
                return count;
            };

            // Reactive state for filtering and UI
            const appState = state({
                tagIcons: tagIcons,
                user: user,
                currentAccount: null,
                currentTag: null,
                currentFolder: null,
                selectedFolderId: 'folder-Inbox',
                editingEmail: null,
                getCount: getEmailCount,
                getAccountIconClass,
                get emails() {  // Made reactive getter dependent on user (like contacts' filteredContacts)
                    return getEmailsFromAccounts(this.user);
                },
                get filteredEmails() {
                    let filtered = this.emails;  // Now reactive

                    // First filter by account if one is selected
                    if (this.currentAccount) {
                        filtered = filtered.filter(e => e.sourceAccount === this.currentAccount);
                    }

                    // Then apply additional filters based on current selection
                    if (this.currentTag) {
                        if (this.currentTag === 'starred') {
                            filtered = filtered.filter(e => e.starred);
                        } else if (this.currentTag === 'snoozed') {
                            filtered = filtered.filter(e => e.snoozed);
                        } else if (this.currentTag === 'scheduled') {
                            filtered = filtered.filter(e => e.scheduled);
                        } else {
                            filtered = filtered.filter(e => e.tags && e.tags.includes(this.currentTag));
                        }
                    } else if (this.currentFolder) {
                        const lowerCaseFolder = this.currentFolder.toLowerCase();
                        switch (lowerCaseFolder) {
                            case 'starred':
                                filtered = filtered.filter(e => e.starred);
                                break;
                            case 'snoozed':
                                filtered = filtered.filter(e => e.snoozed);
                                break;
                            case 'scheduled':
                                filtered = filtered.filter(e => e.scheduled);
                                break;
                            default:
                                // For other folders like Inbox, Drafts, Sent, Spam, Trash
                                filtered = filtered.filter(e => e.folder === this.currentFolder);
                                break;
                        }
                    } else {
                        // Default to Inbox only if no account, tag, or folder is selected (matches contacts' "All Contacts" default behavior)
                        if (!this.currentAccount && !this.currentTag && !this.currentFolder) {
                            filtered = filtered.filter(e => e.folder === 'Inbox');
                        }
                        // If account is selected but no tag/folder, show all emails from the account (no folder filter)
                    }

                    return filtered;
                },
                selectFolder(folderType, value) {
                    if (folderType === 'account') {
                        this.currentAccount = value;
                        this.currentTag = null;
                        this.currentFolder = null;
                        this.selectedFolderId = value ? `account-${value.replace('@', '-at-')}` : 'folder-Inbox';
                    } else if (folderType === 'tag') {
                        this.currentTag = value;
                        this.currentFolder = null;
                        this.selectedFolderId = `category-${value}`;
                    } else if (folderType === 'folder') {
                        this.currentFolder = value;
                        this.currentTag = null;
                        // Removed: if (value === 'Inbox') { this.currentAccount = null; }  // Keep account selection for folder changes
                        this.selectedFolderId = `folder-${value}`;
                    }
                },
                updateSnooze(emailId, newDateTime) {
                    const email = this.emails.find(e => e.id === emailId);  // Now reactive
                    if (email) {
                        if (newDateTime) {
                            email.snoozed = new Date(newDateTime).toISOString();
                        } else {
                            delete email.snoozed;
                        }
                    }
                },
                updateSchedule(emailId, newDateTime) {
                    const email = this.emails.find(e => e.id === emailId);  // Now reactive
                    if (email) {
                        if (newDateTime) {
                            email.scheduled = new Date(newDateTime).toISOString();
                        } else {
                            delete email.scheduled;
                        }
                    }
                }
            });

            document.getElementById("init").replaceWith(await Emails(appState))
        </script>
    </body>
</html>